Continuous Monitoring
Monitoring with Evidently üß™
30 min
What you will learn in this course üßêüßê

Monitoring ML model is quite a new field. The tools are emerging and there aren't only one tool to achieve our goal.

We are going to use evidently a library really convenient to detect most of the drifts problems.
Install evidently

It is straightforward to install evidently:

try:
    import evidently
except:
    !pip install evidently==0.6.1

/opt/anaconda3/lib/python3.12/site-packages/evidently/core/metric_types.py:375: FutureWarning: In the future `np.bool` will be defined as the corresponding NumPy scalar.
  np_bool = np.bool  # type: ignore[attr-defined]

import pandas as pd

from sklearn import datasets

from evidently.test_suite import TestSuite
from evidently.test_preset import DataStabilityTestPreset

from evidently.report import Report
from evidently.metric_preset import DataDriftPreset

from evidently.pipeline.column_mapping import ColumnMapping

Monitoring workflow

Let's learn how evidently works!

Imagine we have a ML model able to predict Boston house price in production. In fact, data are from the Boston dataset.
NOTE

The samples are available in Resources. üëâ

Here how they look:

# Replace the path with your actual path
reference = pd.read_csv("./src/reference-sample.csv")
production = pd.read_csv("./src/production-sample.csv")

reference.head()

      CRIM    ZN  INDUS  CHAS    NOX     RM   AGE     DIS  RAD    TAX  \
0  0.00632  18.0   2.31     0  0.538  6.575  65.2  4.0900    1  296.0
1  0.02731   0.0   7.07     0  0.469  6.421  78.9  4.9671    2  242.0
2  0.02729   0.0   7.07     0  0.469  7.185  61.1  4.9671    2  242.0
3  0.03237   0.0   2.18     0  0.458  6.998  45.8  6.0622    3  222.0
4  0.06905   0.0   2.18     0  0.458  7.147  54.2  6.0622    3  222.0

   PTRATIO       B  LSTAT
0     15.3  396.90   4.98
1     17.8  396.90   9.14
2     17.8  392.83   4.03
3     18.7  394.63   2.94
4     18.7  396.90   5.33

reference.describe()

             CRIM          ZN       INDUS       CHAS         NOX          RM  \
count  400.000000  400.000000  400.000000  400.00000  400.000000  400.000000
mean     1.750859   14.375000    9.416350    0.08750    0.530119    6.336232
std      5.987782   25.397726    6.511713    0.28292    0.113920    0.733711
min      0.006320    0.000000    0.460000    0.00000    0.385000    3.561000
25%      0.066098    0.000000    4.125000    0.00000    0.442000    5.890500
50%      0.160735    0.000000    7.015000    0.00000    0.505500    6.227500
75%      0.731915   21.000000   13.920000    0.00000    0.581000    6.686250
max     88.976200  100.000000   25.650000    1.00000    0.871000    8.780000

              AGE         DIS         RAD         TAX     PTRATIO           B  \
count  400.000000  400.000000  400.000000  400.000000  400.000000  400.000000
mean    64.081750    4.199694    6.617500  349.780000   18.004500  379.854450
std     28.990673    2.177279    6.303215  128.403447    2.220565   40.692472
min      2.900000    1.129600    1.000000  187.000000   12.600000   70.800000
25%     37.675000    2.341350    4.000000  276.000000   16.600000  381.187500
50%     68.750000    3.876050    5.000000  307.000000   18.400000  392.525000
75%     91.900000    5.658650    6.000000  403.000000   20.200000  396.540000
max    100.000000   12.126500   24.000000  666.000000   22.000000  396.900000

            LSTAT
count  400.000000
mean    11.250575
std      6.770453
min      1.730000
25%      6.285000
50%      9.605000
75%     14.477500
max     37.970000

reference is the data sample we took from our training set. It could be the whole training set of just a sample if the dataset is too big.

production is a sample of user inputs we logged while our ML model was in production. Those data are comes from outside world and could be drifted from our reference set.
Data drift

Evidently offers several ways to get the report. It is able to generate a dashboard inside a Jupyter Notebook or to generate a JSON that you could use later on inside your system.

Let's check them both.

Let's declare a ColumnMapping and precise the column names in a list that belongs to the numerical_features category. You can also precise categorical_feature, target or prediction.

Now we have initialized that, let's see if we have data drift.
HTML dashboard

ColumnMapping(numerical_features=[
    "CRIM",
    "ZN",
    "INDUS",
    "CHAS",
    "NOX",
    "RM",
    "AGE",
    "DIS",
    "RAD",
    "TAX",
    "PTRATIO",
    "B",
    "LSTAT",
])

ColumnMapping(target='target', prediction='prediction', datetime='datetime', id=None, numerical_features=['CRIM', 'ZN', 'INDUS', 'CHAS', 'NOX', 'RM', 'AGE', 'DIS', 'RAD', 'TAX', 'PTRATIO', 'B', 'LSTAT'], categorical_features=None, datetime_features=None, target_names=None, task=None, pos_label=1, text_features=None, embeddings=None, user_id='user_id', item_id='item_id', recommendations_type=<RecomType.SCORE: 'score'>)

data_stability= TestSuite(tests=[
    DataStabilityTestPreset(),
])
data_stability.run(current_data=production, reference_data=reference, column_mapping=None)
data_stability.show("inline")

<IPython.core.display.HTML object>

data_drift_report = Report(metrics=[
    DataDriftPreset(),
])

data_drift_report.run(current_data=production, reference_data=reference, column_mapping=None)
data_drift_report.show("inline")

<IPython.core.display.HTML object>

Profile

In order to integrate evidently's results into other elements of your data pipeline, you may export them as json or dictionnary files.

data_drift_dict = data_drift_report.as_dict()

data_drift_dict

{'metrics': [{'metric': 'DatasetDriftMetric',
   'result': {'drift_share': 0.5,
    'number_of_columns': 13,
    'number_of_drifted_columns': 13,
    'share_of_drifted_columns': 1.0,
    'dataset_drift': True}},
  {'metric': 'DataDriftTable',
   'result': {'number_of_columns': 13,
    'number_of_drifted_columns': 13,
    'share_of_drifted_columns': 1.0,
    'dataset_drift': True,
    'drift_by_columns': {'AGE': {'column_name': 'AGE',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 2.986577225210549e-11,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [28.8,
         35.92,
         43.04,
         50.16,
         57.28,
         64.4,
         71.52,
         78.64,
         85.76,
         92.88,
         100.0],
        'y': [0.0013249947000211998,
         0.0039749841000636015,
         0.0013249947000212002,
         0.005299978800084796,
         0.001324994700021199,
         0.010599957600169616,
         0.011924952300190791,
         0.01722493110027559,
         0.025174899300402835,
         0.06227475090099636]}},
      'reference': {'small_distribution': {'x': [2.9,
         12.61,
         22.319999999999997,
         32.029999999999994,
         41.739999999999995,
         51.449999999999996,
         61.15999999999999,
         70.87,
         80.58,
         90.28999999999999,
         100.0],
        'y': [0.003604531410916581,
         0.007981462409886717,
         0.007209062821833163,
         0.010556127703398557,
         0.007466529351184346,
         0.008496395468589088,
         0.008238928939237887,
         0.007209062821833166,
         0.012873326467559225,
         0.02935118434603499]}}},
     'B': {'column_name': 'B',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 3.610608216668809e-13,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [0.32,
         39.978,
         79.636,
         119.294,
         158.952,
         198.61,
         238.268,
         277.926,
         317.584,
         357.242,
         396.9],
        'y': [0.004281893205777321,
         0.001189414779382589,
         0.0019030636470121424,
         0.0002378829558765178,
         0.0002378829558765177,
         0.0002378829558765179,
         0.0007136488676295537,
         0.0009515318235060708,
         0.0028545954705182126,
         0.012607796661455457]}},
      'reference': {'small_distribution': {'x': [70.8,
         103.41,
         136.01999999999998,
         168.63,
         201.24,
         233.85000000000002,
         266.46,
         299.07,
         331.68,
         364.29,
         396.9],
        'y': [0.00022999080036798528,
         7.66636001226618e-05,
         0.0,
         0.00015332720024532345,
         0.00015332720024532345,
         0.00030665440049064744,
         0.0003066544004906469,
         0.0003833180006133086,
         0.0020699172033118666,
         0.026985587243176977]}}},
     'CHAS': {'column_name': 'CHAS',
      'column_type': 'num',
      'stattest_name': 'Z-test p_value',
      'stattest_threshold': 0.05,
      'drift_score': 0.0015961134563933221,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [-0.5,
         -0.4,
         -0.3,
         -0.19999999999999996,
         -0.09999999999999998,
         0.0,
         0.10000000000000009,
         0.20000000000000007,
         0.30000000000000004,
         0.4,
         0.5],
        'y': [0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         9.999999999999991,
         0.0,
         0.0,
         0.0,
         0.0]}},
      'reference': {'small_distribution': {'x': [0.0,
         0.1,
         0.2,
         0.30000000000000004,
         0.4,
         0.5,
         0.6000000000000001,
         0.7000000000000001,
         0.8,
         0.9,
         1.0],
        'y': [9.125,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.8750000000000001]}}},
     'CRIM': {'column_name': 'CRIM',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 1.3436966050188847e-40,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [0.04527,
         7.394152999999999,
         14.743035999999998,
         22.091918999999994,
         29.440801999999994,
         36.789685,
         44.13856799999999,
         51.48745099999999,
         58.836333999999994,
         66.185217,
         73.5341],
        'y': [0.06675382336823829,
         0.046214185408780355,
         0.010269818979728973,
         0.005134909489864483,
         0.0,
         0.0025674547449322438,
         0.0025674547449322416,
         0.0,
         0.0,
         0.0025674547449322416]}},
      'reference': {'small_distribution': {'x': [0.00632,
         8.903308,
         17.800296,
         26.697284,
         35.594272000000004,
         44.491260000000004,
         53.388248000000004,
         62.285236000000005,
         71.182224,
         80.079212,
         88.9762],
        'y': [0.10621572154531397,
         0.003652921640447307,
         0.0019669578063947037,
         0.0,
         0.0002809939723421005,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0002809939723421002]}}},
     'DIS': {'column_name': 'DIS',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 2.2453845631266564e-24,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [1.1781,
         1.47012,
         1.76214,
         2.05416,
         2.3461800000000004,
         2.6382000000000003,
         2.9302200000000003,
         3.22224,
         3.51426,
         3.80628,
         4.0983],
        'y': [0.193835263286438,
         0.35536464935847,
         0.8722586847889717,
         0.6138116670737198,
         0.6138116670737208,
         0.3876705265728763,
         0.1615293860720318,
         0.09691763164321908,
         0.06461175442881271,
         0.06461175442881271]}},
      'reference': {'small_distribution': {'x': [1.1296,
         2.2292899999999998,
         3.32898,
         4.42867,
         5.52836,
         6.62805,
         7.727740000000001,
         8.82743,
         9.92712,
         11.026810000000001,
         12.1265],
        'y': [0.20914985132173616,
         0.15913575644045136,
         0.16822922823704858,
         0.13867544489810768,
         0.10457492566086808,
         0.05910756667788191,
         0.04319399103383685,
         0.01591357564404513,
         0.009093471796597218,
         0.002273367949149308]}}},
     'INDUS': {'column_name': 'INDUS',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 3.9300022952549206e-33,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [9.69,
         11.495,
         13.299999999999999,
         15.104999999999999,
         16.909999999999997,
         18.714999999999996,
         20.519999999999996,
         22.324999999999996,
         24.129999999999995,
         25.934999999999995,
         27.74],
        'y': [0.041812575131970946,
         0.026132859457481845,
         0.0,
         0.0,
         0.4599383264516804,
         0.0,
         0.0,
         0.0,
         0.0,
         0.02613285945748179]}},
      'reference': {'small_distribution': {'x': [0.46,
         2.9789999999999996,
         5.497999999999999,
         8.017,
         10.536,
         13.055,
         15.573999999999998,
         18.093,
         20.612,
         23.130999999999997,
         25.65],
        'y': [0.055577610162763004,
         0.08038904327113934,
         0.07939658594680428,
         0.05359269551409289,
         0.020841603811036124,
         0.011909487892020652,
         0.0,
         0.07344184200079401,
         0.014886859865025814,
         0.00694720127034537]}}},
     'LSTAT': {'column_name': 'LSTAT',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 2.5395811007473612e-21,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [5.64,
         8.774,
         11.907999999999998,
         15.041999999999998,
         18.176,
         21.31,
         24.443999999999996,
         27.577999999999996,
         30.711999999999996,
         33.846,
         36.98],
        'y': [0.015050992763482682,
         0.027091786974268835,
         0.06622436815932378,
         0.084285559475503,
         0.04515297829044803,
         0.04515297829044808,
         0.02107138986887575,
         0.00602039710539307,
         0.0,
         0.009030595658089606]}},
      'reference': {'small_distribution': {'x': [1.73,
         5.354,
         8.978,
         12.602,
         16.226,
         19.85,
         23.474,
         27.098000000000003,
         30.722,
         34.346,
         37.97],
        'y': [0.051738410596026484,
         0.07105408388520972,
         0.060016556291390716,
         0.04139072847682121,
         0.022075055187637953,
         0.010347682119205302,
         0.006208609271523174,
         0.008967991169977927,
         0.0020695364238410624,
         0.002069536423841058]}}},
     'NOX': {'column_name': 'NOX',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 2.764243157081563e-38,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [0.532,
         0.5528000000000001,
         0.5736,
         0.5944,
         0.6152,
         0.636,
         0.6568,
         0.6776,
         0.6984,
         0.7192,
         0.74],
        'y': [2.267779390420895,
         2.2677793904209076,
         10.885341074020298,
         8.164005805515266,
         0.0,
         1.3606676342525372,
         0.9071117561683629,
         6.803338171262686,
         9.524673439767811,
         5.896226415094328]}},
      'reference': {'small_distribution': {'x': [0.385,
         0.4336,
         0.4822,
         0.5307999999999999,
         0.5794,
         0.628,
         0.6766,
         0.7252000000000001,
         0.7738,
         0.8224,
         0.871],
        'y': [3.8580246913580267,
         4.115226337448557,
         4.57818930041153,
         2.572016460905345,
         1.8518518518518527,
         1.2860082304526756,
         1.080246913580245,
         0.41152263374485615,
         0.0,
         0.8230452674897123]}}},
     'PTRATIO': {'column_name': 'PTRATIO',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 2.542075410060563e-37,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [19.2,
         19.38,
         19.56,
         19.74,
         19.919999999999998,
         20.1,
         20.28,
         20.46,
         20.64,
         20.82,
         21.0],
        'y': [0.4192872117400426,
         0.0,
         0.0,
         0.0,
         0.0,
         4.874213836477995,
         0.0,
         0.0,
         0.0,
         0.2620545073375266]}},
      'reference': {'small_distribution': {'x': [12.6,
         13.54,
         14.48,
         15.42,
         16.36,
         17.3,
         18.240000000000002,
         19.18,
         20.12,
         21.060000000000002,
         22.0],
        'y': [0.03989361702127661,
         0.005319148936170206,
         0.15425531914893625,
         0.03989361702127661,
         0.0930851063829786,
         0.18351063829787206,
         0.2021276595744686,
         0.07180851063829778,
         0.22606382978723374,
         0.04787234042553203]}}},
     'RAD': {'column_name': 'RAD',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 3.3412994940687936e-43,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [1.0,
         3.3,
         5.6,
         7.8999999999999995,
         10.2,
         12.5,
         14.799999999999999,
         17.099999999999998,
         19.4,
         21.7,
         24.0],
        'y': [0.020508613617719447,
         0.020508613617719447,
         0.032813781788351114,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.360951599671862]}},
      'reference': {'small_distribution': {'x': [1.0,
         3.3,
         5.6,
         7.8999999999999995,
         10.2,
         12.5,
         14.799999999999999,
         17.099999999999998,
         19.4,
         21.7,
         24.0],
        'y': [0.08369565217391305,
         0.2391304347826087,
         0.03804347826086957,
         0.026086956521739132,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.04782608695652172]}}},
     'RM': {'column_name': 'RM',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 0.01852364314295402,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [4.138,
         4.4635,
         4.789,
         5.1145,
         5.4399999999999995,
         5.765499999999999,
         6.091,
         6.4165,
         6.742,
         7.0675,
         7.393],
        'y': [0.02898298698663885,
         0.0579659739732777,
         0.02898298698663885,
         0.20288090890647195,
         0.4347448047995828,
         0.6666087006926917,
         0.8405066226125267,
         0.49271077877286046,
         0.28982986986638853,
         0.02898298698663885]}},
      'reference': {'small_distribution': {'x': [3.561,
         4.0828999999999995,
         4.6048,
         5.1267,
         5.6486,
         6.1705,
         6.692399999999999,
         7.2143,
         7.736199999999999,
         8.258099999999999,
         8.78],
        'y': [0.009580379383023575,
         0.009580379383023559,
         0.05748227629814145,
         0.1437056907453534,
         0.6754167465031621,
         0.541291435140832,
         0.27304081241617145,
         0.10059398352174755,
         0.06227246598965323,
         0.043111707223606015]}}},
     'TAX': {'column_name': 'TAX',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 4.594754632270873e-50,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [273.0,
         316.8,
         360.6,
         404.4,
         448.2,
         492.0,
         535.8,
         579.5999999999999,
         623.4,
         667.2,
         711.0],
        'y': [0.00107693633152408,
         0.0,
         0.0017230981304385302,
         0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         0.018954079434823783,
         0.0010769363315240813]}},
      'reference': {'small_distribution': {'x': [187.0,
         234.9,
         282.8,
         330.7,
         378.6,
         426.5,
         474.4,
         522.3,
         570.2,
         618.0999999999999,
         666.0],
        'y': [0.002818371607515657,
         0.0038622129436325673,
         0.006419624217119001,
         0.000991649269311064,
         0.003027139874739041,
         0.0014613778705636752,
         0.0,
         0.0,
         0.0,
         0.002296450939457198]}}},
     'ZN': {'column_name': 'ZN',
      'column_type': 'num',
      'stattest_name': 'K-S p_value',
      'stattest_threshold': 0.05,
      'drift_score': 7.263131856490867e-09,
      'drift_detected': True,
      'current': {'small_distribution': {'x': [-0.5,
         -0.4,
         -0.3,
         -0.19999999999999996,
         -0.09999999999999998,
         0.0,
         0.10000000000000009,
         0.20000000000000007,
         0.30000000000000004,
         0.4,
         0.5],
        'y': [0.0,
         0.0,
         0.0,
         0.0,
         0.0,
         9.999999999999991,
         0.0,
         0.0,
         0.0,
         0.0]}},
      'reference': {'small_distribution': {'x': [0.0,
         10.0,
         20.0,
         30.0,
         40.0,
         50.0,
         60.0,
         70.0,
         80.0,
         90.0,
         100.0],
        'y': [0.0665,
         0.003,
         0.012,
         0.004,
         0.0032500000000000003,
         0.0015,
         0.001,
         0.0015,
         0.00475,
         0.0025]}}}},
    'current_fi': None,
    'reference_fi': None}}]}

data_drift_dict["metrics"][0]

{'metric': 'DatasetDriftMetric',
 'result': {'drift_share': 0.5,
  'number_of_columns': 13,
  'number_of_drifted_columns': 13,
  'share_of_drifted_columns': 1.0,
  'dataset_drift': True}}

Okay! We have detected data drift in our dataset. Let's check how many variables are concerned:

All of them are concerned! It may be time to re-create a new training set from the input data and labellised them so as to watch target drift and retrain the model afterwards.
Behind the scene

How does it work behind the scene?

evidently and most of ML data and model monitoring libraries are based on statistical tests. It checks some of your set features (like the feature types, number of values, etc.) and choose the best statistical test for the case.

You can check more about which tests are used by evidently in the documentation.
Resources üìöüìö

    whylogs, a competitor of evidently that tries to create a data logging open standard.
